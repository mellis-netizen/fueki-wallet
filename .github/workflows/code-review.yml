name: Automated Code Review

on:
  pull_request:
    types: [opened, synchronize]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  auto-review:
    name: AI-Powered Code Review
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed files
        id: changed_files
        run: |
          git diff --name-only origin/${{ github.base_ref }}...HEAD > changed_files.txt
          echo "Changed files:"
          cat changed_files.txt

      - name: Complexity Analysis
        run: |
          # Simple complexity check for Swift files
          for file in $(cat changed_files.txt | grep "\.swift$"); do
            if [ -f "$file" ]; then
              lines=$(wc -l < "$file")
              if [ "$lines" -gt 500 ]; then
                echo "::warning file=$file::File has $lines lines (>500). Consider splitting."
              fi
            fi
          done

      - name: Check for TODO/FIXME
        run: |
          if grep -r "TODO\|FIXME" $(cat changed_files.txt) 2>/dev/null; then
            echo "::warning::Found TODO/FIXME comments in PR"
          fi

      - name: Comment PR with Review
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const changedFiles = fs.readFileSync('changed_files.txt', 'utf8').split('\n').filter(f => f);

            const swiftFiles = changedFiles.filter(f => f.endsWith('.swift'));
            const testFiles = changedFiles.filter(f => f.includes('Test'));

            const body = `## ðŸ¤– Automated Code Review

            ### Summary
            - **Files Changed**: ${changedFiles.length}
            - **Swift Files**: ${swiftFiles.length}
            - **Test Files**: ${testFiles.length}

            ### Checklist
            - [ ] All tests passing
            - [ ] Code coverage maintained
            - [ ] No security vulnerabilities
            - [ ] SwiftLint checks passed

            *This is an automated review. Human review is still required.*
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
